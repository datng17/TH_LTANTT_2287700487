#!/usr/bin/env python
import os
import re
import subprocess
import sys
import stat
from datetime import datetime

LOG_FILE = "gitsecure.log"  # Tên file log
# Các mẫu để phát hiện thông tin nhạy cảm như API key, mật khẩu, token
SENSITIVE_PATTERNS = [
    r"apikey\s*=\s*['\"][A-Za-z0-9_\-]{16,}['\"]",
    r"secret\s*=\s*['\"][A-Za-z0-9_\-]{8,}['\"]",
    r"password\s*=\s*['\"][^\"\']{4,}['\"]",
    r"token\s*=\s*['\"][A-Za-z0-9]{10,}['\"]",
    r"(AKIA|ASIA)[A-Z0-9]{16}"
]

# Hàm để ghi log ra file
def log(msg):
    with open(LOG_FILE, "a") as f:
        f.write(f"[{datetime.now()}] {msg}\n")

# Hàm quét thông tin nhạy cảm trong một file
def scan_sensitive(file_path):
    try:
        with open(file_path, "r", errors="ignore") as f:
            content = f.read()
            for pattern in SENSITIVE_PATTERNS:
                if re.search(pattern, content, re.IGNORECASE):
                    return f"Sensitive info found in {file_path}: pattern {pattern}"
    except Exception:
        return None
    return None

# Hàm kiểm tra quyền ghi file (world-writable)
def check_permissions(file_path):
    st = os.stat(file_path)
    if st.st_mode & stat.S_IWOTH:
        return f"File {file_path} is world-writable!"
    return None

# Hàm chạy công cụ quét lỗ hổng Bandit
def run_bandit():
    try:
        result = subprocess.run(["bandit", "-r", "."], capture_output=True, text=True)
        if "SEVERITY: High" in result.stdout:
            log("Bandit: High severity issues found.")
            return "Bandit: High severity issues found."
    except FileNotFoundError:
        return "Bandit not installed. Run: pip install bandit"
    return None

def main():
    findings = []
    # Lấy danh sách các file đã được `git add`
    files = subprocess.check_output(["git", "diff", "--cached", "--name-only"]).decode().splitlines()
    
    for file in files:
        if not os.path.isfile(file): continue
        
        # Quét thông tin nhạy cảm
        result = scan_sensitive(file)
        if result: findings.append(result)
        
        # Kiểm tra quyền file
        perms = check_permissions(file)
        if perms: findings.append(perms)

    # Chạy Bandit để quét toàn bộ dự án
    bandit_result = run_bandit()
    if bandit_result: findings.append(bandit_result)

    # Nếu có phát hiện, chặn commit và báo cáo
    if findings:
        print("\nCOMMIT BLOCKED by GitSecure:")
        for f in findings:
            print("-", f)
            log(f)
        sys.exit(1) # Thoát với mã lỗi để ngăn commit
    else:
        print("GitSecure: All checks passed.")

if __name__ == "__main__":
    main()
